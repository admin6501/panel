version: '3.8'

services:
  mongodb:
    image: mongo:6
    container_name: wireguard-panel-mongodb
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
    networks:
      - wireguard-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: wireguard-panel-backend
    restart: unless-stopped
    environment:
      - MONGO_URL=mongodb://mongodb:27017
      - DB_NAME=wireguard_panel
      - JWT_SECRET=${JWT_SECRET:-change-this-super-secret-key}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      - WG_INTERFACE=wg0
      - WG_PORT=51820
      - WG_NETWORK=10.0.0.0/24
      - WG_DNS=1.1.1.1,8.8.8.8
    volumes:
      - /etc/wireguard:/etc/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - wireguard-network

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: wireguard-panel-frontend
    restart: unless-stopped
    ports:
      - "${PANEL_PORT:-80}:80"
    depends_on:
      - backend
    networks:
      - wireguard-network

volumes:
  mongodb_data:

networks:
  wireguard-network:
    driver: bridge
